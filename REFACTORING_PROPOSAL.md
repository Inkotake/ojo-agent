# OJO æ¶æ„æ·±åº¦é‡æ„æ–¹æ¡ˆ

> **æ–‡æ¡£æ€§è´¨**ï¼šæ·±åº¦é‡æ„è®¾è®¡æ–‡æ¡£ï¼Œä»…æå‡ºæ–¹æ¡ˆï¼Œä¸æ‰§è¡Œæ“ä½œ
> 
> **ç‰ˆæœ¬**ï¼šä» v7.0/v8.0 æ··åˆæ¶æ„ â†’ v9.0 ç»Ÿä¸€æ¶æ„
> 
> **æ—¥æœŸ**ï¼š2024-12-23

---

## Progress

- [x] Full codebase and docs analysis completed
- [x] Target architecture and scope finalized (auth/config/task/pipeline/websocket)
- [x] Backend refactor implemented and verified
- [x] Production hardening (logging/security/observability) completed
- [x] Deployment package and documentation delivered

### HydroOJ é€‚é…å™¨é—®é¢˜ä¿®å¤ (2026-01-06)

10. **SHSOJProblemFetcher ç¼ºå°‘ fetch_admin_problem æ–¹æ³•** âœ…
    - **é—®é¢˜**: `SHSOJAdapter.fetch_admin_problem()` è°ƒç”¨ `SHSOJProblemFetcher.fetch_admin_problem()`ï¼Œä½†è¯¥æ–¹æ³•ä¸å­˜åœ¨
    - **é”™è¯¯ä¿¡æ¯**: `'SHSOJProblemFetcher' object has no attribute 'fetch_admin_problem'`
    - **ä¿®å¤æ–‡ä»¶**: `src/services/oj/adapters/shsoj/problem_fetcher_impl.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: åœ¨ `SHSOJProblemFetcher` ç±»ä¸­æ·»åŠ  `fetch_admin_problem(auth, pid)` æ–¹æ³•

11. **HydroOJ ä¸Šä¼ åè¿”å›é”™è¯¯çš„é¢˜ç›®ID** âœ…
    - **é—®é¢˜**: åˆ›å»ºæ–°é¢˜ç›®åï¼Œ`_get_latest_problem_id()` ä½¿ç”¨æ¨¡ç³Šæ ‡é¢˜æœç´¢ï¼Œè¿”å›æ ‡é¢˜éƒ¨åˆ†åŒ¹é…çš„æ—§é¢˜ç›®ID
    - **ç¤ºä¾‹**: æœ¬åœ°é¢˜ç›®"ä¹°æ–‡å…·"ï¼Œè¿œç«¯æœåˆ°"ã€æ·±åŸº2.ä¹ 5ã€‘å°ç‰ä¹°æ–‡å…·"çš„ID 504
    - **ä¿®å¤æ–‡ä»¶**: `src/services/oj/adapters/hydrooj/data_uploader_impl.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: `_get_latest_problem_id()` æ”¹ä¸ºç²¾ç¡®æ ‡é¢˜åŒ¹é…ï¼Œè§£æ `<tr data-pid>` ä¸­çš„æ ‡é¢˜å¹¶ä¸¥æ ¼æ¯”å¯¹

12. **HydroOJ å·²å­˜åœ¨åŒåé¢˜ç›®æ—¶è·³è¿‡åˆ›å»º** âœ…
    - **é—®é¢˜**: è¿œç«¯å·²æœ‰ç²¾ç¡®åŒ¹é…çš„é¢˜ç›®æ—¶ä»åˆ›å»ºæ–°é¢˜ç›®
    - **ä¿®å¤æ–‡ä»¶**: `src/services/oj/adapters/hydrooj/data_uploader_impl.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: 
      - æ·»åŠ  `_search_exact_title(title, auth)` è¾…åŠ©æ–¹æ³•è¿›è¡Œç²¾ç¡®æ ‡é¢˜æœç´¢
      - åœ¨ `upload_testcase()` ä¸­ï¼Œæ ‡é¢˜ä¸åŒ¹é…æ—¶è°ƒç”¨ç²¾ç¡®æœç´¢
      - è‹¥æ‰¾åˆ°ç²¾ç¡®åŒ¹é…é¢˜ç›®ï¼Œè¿”å› `{ skipped: True, real_id: existing_id }`

13. **å‰ç«¯ä»»åŠ¡é˜Ÿåˆ—ç¼ºå°‘æ‰“å¼€é“¾æ¥åŠŸèƒ½** âœ…
    - **é—®é¢˜**: `TasksPage.tsx` é˜Ÿåˆ—ä¸­ç¼ºå°‘"æ‰“å¼€ä¸Šä¼ é“¾æ¥"æŒ‰é’®
    - **ä¿®å¤æ–‡ä»¶**: 
      - `frontend/src/components/TaskActionMenu.tsx` - æ·»åŠ "æ‰“å¼€ä¸Šä¼ é“¾æ¥"é€‰é¡¹
      - `frontend/src/pages/TasksPage.tsx` - æ¥å£æ·»åŠ  `uploaded_url` å­—æ®µï¼Œä¼ é€’åˆ° TaskActionMenu
    - **ä¿®å¤æ–¹æ¡ˆ**: ä»»åŠ¡å®Œæˆåå¯ç‚¹å‡»æ‰“å¼€ HydroOJ é¢˜ç›®é¡µé¢

14. **Pipeline è¿œç«¯é¢˜ç›®é¢„æ£€æµ‹** âœ…
    - **é—®é¢˜**: ç”¨æˆ·å¸Œæœ›åœ¨ gen é˜¶æ®µä¹‹å‰å°±æ£€æµ‹è¿œç«¯æ˜¯å¦å·²æœ‰åŒåé¢˜ç›®ï¼Œè‹¥æœ‰åˆ™è·³è¿‡ç”Ÿæˆå’Œä¸Šä¼ 
    - **ä¿®å¤æ–‡ä»¶**: `src/services/pipeline.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: 
      - åœ¨ gen é˜¶æ®µä¹‹å‰æ·»åŠ  `[CHECK]` é¢„æ£€æµ‹é€»è¾‘
      - è°ƒç”¨ `_search_exact_title()` æ£€æŸ¥ HydroOJ è¿œç«¯æ˜¯å¦å·²æœ‰åŒåé¢˜ç›®
      - è‹¥å·²æœ‰ï¼šè®¾ç½® `ok_gen=True`, `ok_upload=True`ï¼Œæ„å»º `uploaded_url`ï¼Œè·³è¿‡åç»­ gen/upload é˜¶æ®µ
      - å‰ç«¯æ˜¾ç¤º"è·³è¿‡(è¿œç«¯å·²æœ‰)" / "è·³è¿‡(å·²å­˜åœ¨)"çŠ¶æ€

15. **TasksPage ä»»åŠ¡ ID å­—æ®µæ˜ å°„ä¿®å¤** âœ…
    - **é—®é¢˜**: åç«¯è¿”å› `id` å­—æ®µï¼Œä½†å‰ç«¯é”™è¯¯åœ°ä½¿ç”¨ `task_id`
    - **ä¿®å¤æ–‡ä»¶**: `frontend/src/pages/TasksPage.tsx`
    - **ä¿®å¤æ–¹æ¡ˆ**: ç±»å‹å®šä¹‰æ”¹ä¸º `id: number`ï¼Œå¹¶æ­£ç¡®æ˜ å°„åˆ° `task_id: String(task.id)`

16. **HydroOJ æœç´¢æ–¹æ³•ç²¾ç¡®åŒ¹é…é‡æ„** âœ…
    - **é—®é¢˜**: `_get_latest_problem_id` ä¸ `_search_exact_title` æœ‰é‡å¤ä»£ç 
    - **ä¿®å¤æ–‡ä»¶**: `src/services/oj/adapters/hydrooj/data_uploader_impl.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: `_get_latest_problem_id` é‡æ„ä¸ºè°ƒç”¨ `_search_exact_title`ï¼Œæ¶ˆé™¤ä»£ç é‡å¤

17. **HydroOJ `_search_problem_by_title` ç²¾ç¡®åŒ¹é…** âœ…
    - **é—®é¢˜**: solver ä¸­ä½¿ç”¨çš„æœç´¢æ–¹æ³•æœ‰æ¨¡ç³ŠåŒ¹é… fallbackï¼Œå¯èƒ½è¿”å›é”™è¯¯é¢˜ç›®
    - **ä¿®å¤æ–‡ä»¶**: `src/services/oj/adapters/hydrooj/data_uploader_impl.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: ç§»é™¤æ¨¡ç³ŠåŒ¹é… fallbackï¼Œä»…è¿”å›ç²¾ç¡®æ ‡é¢˜åŒ¹é…çš„é¢˜ç›®

18. **HydroOJ æ ‡é¢˜è§„èŒƒåŒ–å’Œ real_id å›é€€** âœ… (2026-01-06)
    - **é—®é¢˜**: æ ‡é¢˜ä¸­å¤šä½™ç©ºæ ¼å¯¼è‡´ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼›ä¸Šä¼ æˆåŠŸä½†æ— æ³•è·å– real_id
    - **ä¿®å¤æ–‡ä»¶**: `src/services/oj/adapters/hydrooj/data_uploader_impl.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: 
      - `_search_exact_title` ä½¿ç”¨ `' '.join(title.strip().split())` è§„èŒƒåŒ–æ ‡é¢˜
      - `_upload_to_hydro` HTTP 200 æ—¶è‹¥æ— æ³•ä» JSON è·å– real_idï¼Œå›é€€åˆ°æ ‡é¢˜æœç´¢

19. **å‰ç«¯æ‰“å¼€é“¾æ¥æŒ‰é’®éªŒè¯** âœ… (2026-01-06)
    - **é—®é¢˜**: `uploadedUrl` ä¸ºç©ºæˆ–æ— æ•ˆæ—¶ç‚¹å‡»æ— å“åº”
    - **ä¿®å¤æ–‡ä»¶**: `frontend/src/components/TaskActionMenu.tsx`
    - **ä¿®å¤æ–¹æ¡ˆ**: å¢åŠ  URL æœ‰æ•ˆæ€§éªŒè¯ï¼Œæ— æ•ˆæ—¶æ˜¾ç¤ºé”™è¯¯æç¤º

20. **CHECK é˜¶æ®µå·²ä¿å­˜ ID å›é€€æœºåˆ¶** âœ… (2026-01-06)
    - **é—®é¢˜**: ç²¾ç¡®æ ‡é¢˜æœç´¢å¤±è´¥æ—¶æ— å›é€€æœºåˆ¶
    - **ä¿®å¤æ–‡ä»¶**: `src/services/pipeline.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: ç²¾ç¡®æœç´¢å¤±è´¥æ—¶æ£€æŸ¥å·²ä¿å­˜çš„ real_idï¼Œå¹¶éªŒè¯è¯¥é¢˜ç›®æ˜¯å¦ä»å­˜åœ¨

### ä»»åŠ¡æ—¥å¿—æ— æ³•æŸ¥çœ‹ä¿®å¤ (2026-01-09)

21. **Pipeline æ—¥å¿—ç¼“å†²åŒºæœªåˆ·æ–°å¯¼è‡´æ—¥å¿—ä¸ºç©º** âœ…
    - **é—®é¢˜**: ä»»åŠ¡ç»“æŸæˆ–æå‰è¿”å›æ—¶ï¼Œ`_flush_file_buffer(pid)` æœªè¢«è°ƒç”¨ï¼Œå¯¼è‡´æ—¥å¿—å†…å®¹ç•™åœ¨ç¼“å†²åŒºæœªå†™å…¥ `pipeline.log` æ–‡ä»¶
    - **ä¿®å¤æ–‡ä»¶**: `src/services/pipeline.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: 
      - åœ¨æ‰€æœ‰æå‰ `return result` çš„ä½ç½®æ·»åŠ  `_flush_file_buffer(pid)` è°ƒç”¨
      - åŒ…æ‹¬ï¼šä»»åŠ¡å–æ¶ˆã€é¢˜ç›®ä¸å­˜åœ¨ã€è¿œç«¯å·²æœ‰é¢˜ç›®ã€ä»»åŠ¡å®Œæˆã€å¼‚å¸¸æ•è·ç­‰åˆ†æ”¯
      - ç¡®ä¿æ— è®ºä»»åŠ¡ä»¥ä½•ç§æ–¹å¼ç»“æŸï¼Œæ—¥å¿—éƒ½ä¼šè¢«æ­£ç¡®åˆ·æ–°åˆ°æ–‡ä»¶

22. **task_service.get_task_logs æ·»åŠ è°ƒè¯•æ—¥å¿—** âœ…
    - **é—®é¢˜**: æ—¥å¿—è¯»å–å¤±è´¥æ—¶éš¾ä»¥å®šä½åŸå› 
    - **ä¿®å¤æ–‡ä»¶**: `src/services/task_service.py`
    - **ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ è¯¦ç»†çš„ DEBUG æ—¥å¿—ï¼Œè®°å½•ä»»åŠ¡IDã€é—®é¢˜IDã€ç”¨æˆ·IDã€å·¥ä½œåŒºè·¯å¾„åŠæ–‡ä»¶å­˜åœ¨çŠ¶æ€

23. **Dashboard æ·»åŠ é‡è¯•æŒ‰é’®** âœ… (2026-01-09)
    - **é—®é¢˜**: ä»»åŠ¡ä»ªè¡¨ç›˜æ²¡æœ‰é‡è¯•åŠŸèƒ½ï¼Œéœ€è¦å»ä»»åŠ¡é˜Ÿåˆ—é¡µé¢æ‰èƒ½é‡è¯•
    - **ä¿®å¤æ–‡ä»¶**: `frontend/src/pages/Dashboard.tsx`
    - **ä¿®å¤æ–¹æ¡ˆ**: 
      - åœ¨ä»»åŠ¡åˆ—è¡¨æ·»åŠ é‡è¯•æŒ‰é’®ï¼ˆåˆ·æ–°å›¾æ ‡ï¼‰
      - å¤±è´¥ä»»åŠ¡ï¼ˆstatus=3ï¼‰æ˜¾ç¤ºé‡è¯•æŒ‰é’®
      - ç®¡ç†å‘˜å¯é‡è¯•ä»»æ„éè¿è¡Œä¸­çš„ä»»åŠ¡ï¼ˆåˆ©ç”¨å·²æœ‰çš„ `is_admin` æƒé™æ£€æŸ¥ï¼‰
      - ç‚¹å‡»é‡è¯•æ—¶æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†

### é¡¹ç›®ä¿¡æ¯ä¸­å¿ƒåŠŸèƒ½ (2026-01-09) âœ… å·²å®Œæˆ

**åŠŸèƒ½æ¦‚è¿°**: åœ¨ä¸»ç•Œé¢å³ä¸Šè§’æ·»åŠ é¡¹ç›®ä¿¡æ¯å…¥å£ï¼ŒåŒ…å«æ›´æ–°æ—¥å¿—å’Œç”¨æˆ·åé¦ˆç³»ç»Ÿ

24. **æ•°æ®åº“æ–°å¢è¡¨ç»“æ„** âœ…
    - **æ–°å¢è¡¨**: 
      - `changelogs` - æ›´æ–°æ—¥å¿—è¡¨ï¼ˆversion, title, content, type, is_published, publish_date, created_byï¼‰
      - `user_changelog_reads` - ç”¨æˆ·å·²è¯»è®°å½•è¡¨ï¼ˆuser_id, last_read_changelog_idï¼‰
      - `feedbacks` - ç”¨æˆ·åé¦ˆè¡¨ï¼ˆuser_id, type, title, content, status, priority, admin_reply, admin_idï¼‰
    - **ä¿®æ”¹æ–‡ä»¶**: `src/core/database.py`
    - **ç´¢å¼•ä¼˜åŒ–**: changelogs(is_published, publish_date DESC), feedbacks(status, user_id)
    - **æ•°æ®åº“æ–¹æ³•**: 
      - æ›´æ–°æ—¥å¿—: `create_changelog`, `update_changelog`, `delete_changelog`, `get_changelogs`, `get_changelog_by_id`, `get_latest_published_changelog_id`
      - å·²è¯»è®°å½•: `get_user_last_read_changelog_id`, `mark_changelog_read`, `get_unread_changelog_count`
      - ç”¨æˆ·åé¦ˆ: `create_feedback`, `update_feedback`, `get_feedbacks`, `get_feedback_by_id`, `delete_feedback`

25. **é¡¹ç›®ä¿¡æ¯ API** âœ…
    - **æ–°å¢æ–‡ä»¶**: `src/api/routes/project.py`
    - **API ç«¯ç‚¹**:
      - `GET /api/project/changelogs` - è·å–æ›´æ–°æ—¥å¿—åˆ—è¡¨
      - `GET /api/project/changelogs/unread-count` - è·å–æœªè¯»æ›´æ–°æ•°é‡ï¼ˆå°çº¢ç‚¹ç”¨ï¼‰
      - `POST /api/project/changelogs/mark-read` - æ ‡è®°æ›´æ–°æ—¥å¿—ä¸ºå·²è¯»
      - `GET /api/project/changelogs/{id}` - è·å–å•ä¸ªæ›´æ–°æ—¥å¿—è¯¦æƒ…
      - `POST /api/project/changelogs` - åˆ›å»ºæ›´æ–°æ—¥å¿—ï¼ˆç®¡ç†å‘˜ï¼‰
      - `PUT /api/project/changelogs/{id}` - æ›´æ–°æ›´æ–°æ—¥å¿—ï¼ˆç®¡ç†å‘˜ï¼‰
      - `POST /api/project/changelogs/{id}/publish` - å‘å¸ƒæ›´æ–°æ—¥å¿—ï¼ˆç®¡ç†å‘˜ï¼‰
      - `DELETE /api/project/changelogs/{id}` - åˆ é™¤æ›´æ–°æ—¥å¿—ï¼ˆç®¡ç†å‘˜ï¼‰
      - `GET /api/project/feedbacks` - è·å–åé¦ˆåˆ—è¡¨
      - `POST /api/project/feedbacks` - æäº¤åé¦ˆ
      - `GET /api/project/feedbacks/{id}` - è·å–å•ä¸ªåé¦ˆè¯¦æƒ…
      - `PUT /api/project/feedbacks/{id}/reply` - ç®¡ç†å‘˜å›å¤åé¦ˆ
      - `DELETE /api/project/feedbacks/{id}` - åˆ é™¤åé¦ˆ
    - **è·¯ç”±æ³¨å†Œ**: `src/api/server.py` æ·»åŠ  `project.router`

26. **å‰ç«¯é€šçŸ¥çŠ¶æ€ç®¡ç†** âœ…
    - **æ–°å¢æ–‡ä»¶**: `frontend/src/stores/notificationStore.ts`
    - **åŠŸèƒ½**:
      - Zustand store ç®¡ç†æœªè¯»æ›´æ–°è®¡æ•°
      - LocalStorage æŒä¹…åŒ–å·²è¯»çŠ¶æ€ï¼ˆä¼˜é›…é™çº§ï¼‰
      - å®šæ—¶è½®è¯¢æ£€æŸ¥æ›´æ–°ï¼ˆ5åˆ†é’Ÿé—´éš”ï¼‰
      - `hasUnread()` æ–¹æ³•åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå°çº¢ç‚¹
      - 30ç§’é˜²æŠ–é¿å…é¢‘ç¹è¯·æ±‚

27. **Layout é€šçŸ¥æŒ‰é’® + å°çº¢ç‚¹** âœ…
    - **ä¿®æ”¹æ–‡ä»¶**: `frontend/src/components/Layout.tsx`
    - **åŠŸèƒ½**:
      - å³ä¸Šè§’æ·»åŠ é“ƒé“›å›¾æ ‡æŒ‰é’®ï¼ˆBell iconï¼‰
      - å°çº¢ç‚¹å‘¼å¸åŠ¨ç”»æ•ˆæœï¼ˆanimate-pingï¼‰
      - ç‚¹å‡»è·³è½¬åˆ° `/project-info` é¡µé¢
      - ç™»å½•åå’Œå®šæ—¶è‡ªåŠ¨è·å–æœªè¯»æ•°

28. **é¡¹ç›®ä¿¡æ¯é¡µé¢** âœ…
    - **æ–°å¢æ–‡ä»¶**: `frontend/src/pages/ProjectInfoPage.tsx`
    - **åŠŸèƒ½**:
      - Tab åˆ‡æ¢ï¼šæ›´æ–°æ—¥å¿— / åé¦ˆå»ºè®®
      - æ›´æ–°æ—¥å¿—åˆ—è¡¨ï¼ˆå¡ç‰‡å¼å±•ç¤ºï¼ŒæŒ‰ç±»å‹æ ‡ç­¾åˆ†ç±»ï¼‰
      - ç®¡ç†å‘˜æ›´æ–°æ—¥å¿— CRUD æ“ä½œï¼ˆåˆ›å»º/ç¼–è¾‘/å‘å¸ƒ/åˆ é™¤ï¼‰
      - åé¦ˆæäº¤è¡¨å•ï¼ˆç±»å‹é€‰æ‹©ï¼šåŠŸèƒ½å»ºè®®/BugæŠ¥å‘Š/é—®é¢˜å’¨è¯¢/å…¶ä»–ï¼‰
      - ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„åé¦ˆè®°å½•
      - ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰åé¦ˆ + å›å¤åŠŸèƒ½ï¼ˆçŠ¶æ€/ä¼˜å…ˆçº§/å›å¤å†…å®¹ï¼‰
      - é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ ‡è®°ä¸ºå·²è¯»ï¼ˆæ¸…é™¤å°çº¢ç‚¹ï¼‰

29. **è·¯ç”±é…ç½®** âœ…
    - **ä¿®æ”¹æ–‡ä»¶**: `frontend/src/App.tsx`, `src/api/server.py`
    - **åŠŸèƒ½**: æ·»åŠ  `/project-info` è·¯ç”±ï¼Œæ³¨å†Œåç«¯ API è·¯ç”±

**æŠ€æœ¯æ–¹æ¡ˆè¦ç‚¹**:
- å°çº¢ç‚¹æœºåˆ¶ï¼šåç«¯å­˜å‚¨ + LocalStorage åŒé‡ä¿éšœï¼ˆè·¨è®¾å¤‡åŒæ­¥ + ä¼˜é›…é™çº§ï¼‰
- æœªè¯»åˆ¤æ–­ï¼š`æœ€æ–°æ›´æ–°æ—¥å¿—ID > ç”¨æˆ·å·²è¯»ID`
- æ‰©å±•æ€§ï¼šé¢„ç•™ WebSocket å®æ—¶æ¨é€æ¥å£

### é€‚é…å™¨é…ç½®éš”ç¦»ä¿®å¤ (2024-12-27)

7. **é€‚é…å™¨ç”¨æˆ·é…ç½®éš”ç¦»** âœ…
   - ä¿®å¤ `SHSOJAdapter._ensure_config()` ä»ç”¨æˆ·é…ç½®è¯»å–
   - ä¿®å¤ `HydroOJAdapter._ensure_config()` ä»ç”¨æˆ·é…ç½®è¯»å–
   - åˆ é™¤ `TaskService` è¦†ç›–å…¨å±€ `cfg.adapter_configs` çš„ä»£ç 
   - `Pipeline._initialize_adapters()` ä¼ é€’ `user_id` åˆ° context
   - `Pipeline._get_upload_adapter()` ç¡®ä¿è®¾ç½® `user_id`
   - `Pipeline` URL æ„å»ºä»ç”¨æˆ·é…ç½®è¯»å– `base_url/domain`
   - è¯¦ç»†è®¾è®¡è§ `docs/ADAPTER_CONFIG_ISOLATION_FIX.md`

### é‡æ„å®Œæˆæ¸…å• (2024-12-24)

1. **å®‰å…¨ä¿®å¤** âœ…
   - ä¿®å¤ `api/routes/auth.py` æ˜æ–‡å¯†ç æ¯”è¾ƒ
   - ä¿®å¤ `api/server.py` SHA256â†’bcrypt
   - ç»Ÿä¸€ JWT å¯†é’¥è·å–å‡½æ•°
   - æ·»åŠ  `.gitignore` ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶

2. **è®¤è¯ç³»ç»Ÿç»Ÿä¸€** âœ…
   - åˆ›å»º `services/auth_service.py`
   - é‡æ„ `api/auth.py` ä¸ºè–„åŒ…è£…å±‚
   - å®ç°ç™»å½•é¢‘ç‡é™åˆ¶

3. **é…ç½®ç³»ç»Ÿç»Ÿä¸€** âœ…
   - ç§»é™¤ config.json åŒå†™
   - æ•°æ®åº“ä¸ºå”¯ä¸€çœŸç›¸æº
   - ConfigService ç¼“å­˜åˆ·æ–°

4. **æœåŠ¡å±‚å¼•å…¥** âœ…
   - åˆ›å»º `services/task_service.py`
   - åˆ›å»º `services/secret_service.py`
   - æœåŠ¡å±‚ç»Ÿä¸€å¯¼å‡º

5. **APIå±‚é‡æ„** âœ…
   - **åˆ é™¤** `api/app.py` (é‡å¤å…¥å£)
   - **åˆ é™¤** `api/routes/tasks.py` (ç»•è¿‡ç”¨æˆ·éš”ç¦»)
   - ç»Ÿä¸€å…¥å£ä¸º `api/server.py` (v9.0)

6. **ç”Ÿäº§éƒ¨ç½²åŒ…** âœ…
   - Dockerfile å’Œ docker-compose.yml
   - å¯åŠ¨è„šæœ¬ (Linux/Windows)
   - Nginx é…ç½®ç¤ºä¾‹
   - é‡æ„è¯´æ˜æ–‡æ¡£

7. **æ–‡ä»¶æ¸…ç†** âœ…
   - åˆ é™¤: `api/app.py`, `api/routes/tasks.py`
   - åˆ é™¤: æ—§å¯åŠ¨è„šæœ¬ (`build_and_start.*`, `start_*.bat/sh`)
   - å½’æ¡£: `vj.py`, `server_old.py`, `ARCHITECTURE_FIX_TODO.md`, `PROJECT_TODO.md`, `BUSINESS_REVIEW_TODO.md`, `DEVELOPMENT_REPORT.md`
   - æ¸…ç†: `__pycache__`, `test_check.db`, `summary.*`

8. **æ¶æ„ä¼˜åŒ–** âœ…
   - `server.py` ä» 1600 è¡Œç²¾ç®€åˆ° 318 è¡Œ
   - æ–°å¢ `api/dependencies.py` - å…±äº«ä¾èµ–é¡¹
   - æ–°å¢ `api/schemas.py` - æ•°æ®æ¨¡å‹
   - æ–°å¢ `api/websocket_manager.py` - WebSocket ç®¡ç†å™¨
   - å¼ƒç”¨ `core/config/` æ¨¡å—ï¼Œç»Ÿä¸€ä½¿ç”¨ `services/unified_config`
   - ç§»é™¤ `pipeline.py` ä¸­æœªä½¿ç”¨çš„ `ConfigCenter` å¼•ç”¨

9. **Pipeline æµç¨‹ä¼˜åŒ–** âœ… (2024-12-25)
   - æœ¬åœ°éªŒé¢˜ç§»åˆ° GEN é˜¶æ®µï¼Œä½œä¸ºæ•°æ®ç”Ÿæˆçš„ä¸€ç¯
   - éªŒé¢˜å¤±è´¥è‡ªåŠ¨é‡è¯•ç”Ÿæˆï¼ˆæœ€å¤š3æ¬¡ï¼‰
   - ä¸Šä¼ é˜¶æ®µç§»é™¤é‡å¤éªŒé¢˜ï¼Œä»…ä¿ç•™ä¸Šä¼ +è¿œç¨‹éªŒè¯
   - ä¸Šä¼ å¢åŠ é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
   - ä¿®å¤ Linux å…¼å®¹æ€§ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶åç¼€ï¼‰
   - æ–°å¢å…¨å±€æœ¬åœ°ç¼–è¯‘éªŒé¢˜å¹¶å‘æ§åˆ¶ï¼ˆé¿å… CPU è¿‡è½½ï¼‰

### é—®é¢˜è§£å†³æ¸…å•

| # | é—®é¢˜ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|---|------|------|---------|
| 1 | APIå…¥å£æ–‡ä»¶è‡ƒè‚¿ï¼ˆ1600è¡Œï¼‰ | âœ… å·²è§£å†³ | æ‹†åˆ†åˆ° routes/ã€dependencies.pyã€schemas.py |
| 2 | é…ç½®ç³»ç»Ÿä¸‰å¥—å¹¶å­˜ | âœ… å·²è§£å†³ | ç»Ÿä¸€ä½¿ç”¨ unified_configï¼Œå¼ƒç”¨ core/config |
| 3 | è®¤è¯æ¨¡å—ä¸¤å¥—å®ç° | âœ… å·²è§£å†³ | åˆ›å»º AuthServiceï¼Œç»Ÿä¸€è®¤è¯å…¥å£ |
| 4 | Pipelineè°ƒç”¨é“¾åˆ†å‰ | âœ… å·²è§£å†³ | åˆ é™¤ routes/tasks.pyï¼Œä½¿ç”¨ TaskService |
| 5 | è·¯ç”±æ³¨å†Œæ··ä¹± | âœ… å·²è§£å†³ | ç»Ÿä¸€åœ¨ server.py æ³¨å†Œï¼Œåˆ é™¤é‡å¤ |
| 6 | æ•æ„Ÿä¿¡æ¯æ˜æ–‡å­˜å‚¨ | âœ… å·²è§£å†³ | åˆ›å»º SecretService (FernetåŠ å¯†) |
| 7 | WebSocketç®¡ç†å™¨é‡å¤ | âœ… å·²è§£å†³ | ç‹¬ç«‹ websocket_manager.py |
| 8 | çŠ¶æ€è¿½è¸ªåŒè½¨ | âš ï¸ ä¿ç•™ | DBä¸ºä¸»ï¼ŒProblemDataManagerä¸ºæ—¥å¿—è¯¦æƒ… |
| 9 | å¼‚å¸¸å¤„ç†ä¸ç»Ÿä¸€ | âœ… å·²è§£å†³ | server.py æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†å™¨ |
| 10 | æµ‹è¯•è¦†ç›–ä¸è¶³ | â³ åç»­ | ä¿ç•™ç°æœ‰æµ‹è¯•ï¼Œåç»­å®Œå–„ |
| 11 | æœ¬åœ°éªŒé¢˜ä½ç½®é”™è¯¯ | âœ… å·²è§£å†³ | ç§»åˆ°GENé˜¶æ®µï¼ŒéªŒé¢˜å¤±è´¥è‡ªåŠ¨é‡è¯•ç”Ÿæˆ |
| 12 | ä¸Šä¼ æ— é‡è¯•æœºåˆ¶ | âœ… å·²è§£å†³ | å¢åŠ æœ€å¤š3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ç­‰å¾… |
| 13 | Linuxç¼–è¯‘ä¸å…¼å®¹ | âœ… å·²è§£å†³ | åŠ¨æ€æ£€æµ‹ç³»ç»Ÿï¼Œè‡ªåŠ¨é€‚é…å¯æ‰§è¡Œæ–‡ä»¶åç¼€ |
| 14 | æœ¬åœ°ç¼–è¯‘æ— å¹¶å‘æ§åˆ¶ | âœ… å·²è§£å†³ | ConcurrencyManager å¢åŠ ç¼–è¯‘ä¿¡å·é‡ |
| 11 | retry_task æœªæ‰§è¡Œ | âœ… å·²ä¿®å¤ | æ·»åŠ  _execute_single_retry å¼‚æ­¥æ‰§è¡Œ |

### é—®é¢˜ä¿®å¤çŠ¶æ€ï¼ˆå…¨éƒ¨å®Œæˆï¼‰

| ç±»åˆ« | é—®é¢˜ | çŠ¶æ€ |
|------|------|------|
| P1 | å‡½æ•°é‡å¤å®šä¹‰ | âœ… ç»Ÿä¸€ä½¿ç”¨ dependencies + AuthService |
| P1 | routes/auth.py ç‹¬ç«‹å®ç° | âœ… å®Œå…¨å§”æ‰˜ç»™ AuthService |
| P2 | Pipeline åŒæ­¥é˜»å¡å¼‚æ­¥ | âœ… ä½¿ç”¨ä¸“ç”¨ ThreadPoolExecutor |
| P2 | æˆåŠŸåˆ¤æ–­åŸºäºæ—¥å¿—è§£æ | âœ… ä½¿ç”¨ Pipeline ç»“æ„åŒ–è¿”å›å€¼ |
| P2 | TODO æ³¨é‡Šæ¸…ç† | âœ… è½¬æ¢ä¸ºæ­£ç¡®çš„æœªå®ç°çŠ¶æ€ |
| P2 | å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | âœ… æ–°å¢ 13 ä¸ªå•å…ƒæµ‹è¯• |
| P3 | ä»»åŠ¡è·¯ç”±ç§»è‡³ tasks.py | âœ… server.py 470â†’332è¡Œ |
| P3 | å®Œå–„ç±»å‹æ³¨è§£ | âœ… schemas.py å…¨é‡ Field æè¿° |
| P3 | Repository å±‚æŠ½è±¡ | âœ… 3ä¸ªä»“åº“ç±» |

### å‰ç«¯ä¿®å¤çŠ¶æ€

| é—®é¢˜ | çŠ¶æ€ | ä¿®å¤ |
|------|------|------|
| ç‰ˆæœ¬å·ä¸ä¸€è‡´ | âœ… | LoginPage, Layout, package.json â†’ v9.0 |
| API ç«¯ç‚¹ä¸åŒ¹é… | âœ… | åç«¯æ·»åŠ å…¼å®¹è·¯ç”± |
| ConcurrencyPage API è·¯å¾„ | âœ… | /api/admin/concurrency â†’ /api/concurrency |
| confirm() æ”¹ä¸ºç°ä»£å¯¹è¯æ¡† | âœ… | æ–°å¢ ConfirmDialog ç»„ä»¶ |
| /api/adapters 404 | âœ… | ä¿®å¤å“åº”æ ¼å¼ + åŒè·¯å¾„æ³¨å†Œ |
| /ws WebSocket 403 | âœ… | ä¿®å¤è·¯å¾„ / â†’ /ws |

**å‰ç«¯è¯„ä¼°æŠ¥å‘Šè§: `docs/FRONTEND_REVIEW.md`**

### ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ (2024-12-25)

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç»Ÿä¸€ç™»å½• | âœ… | ç§»é™¤è§’è‰²é€‰æ‹©ï¼Œæ ¹æ®è´¦å·è‡ªåŠ¨åŒºåˆ† |
| é‚€è¯·ç æ³¨å†Œ | âœ… | æ–°ç”¨æˆ·éœ€é‚€è¯·ç æ³¨å†Œï¼Œæ•°æ®åº“è¡¨ `invite_codes` |
| å¯†ç ä¿®æ”¹ | âœ… | ç”¨æˆ·åœ¨è®¾ç½®é¡µè‡ªè¡Œä¿®æ”¹ï¼ŒAPI `/api/auth/change-password` |
| ç®¡ç†å‘˜é‡ç½®å¯†ç  | âœ… | ç®¡ç†é¢æ¿å¯é‡ç½®ä»»æ„ç”¨æˆ·å¯†ç  |
| é‚€è¯·ç ç®¡ç† | âœ… | ç®¡ç†å‘˜ç”Ÿæˆ/æŸ¥çœ‹/åˆ é™¤é‚€è¯·ç  |

**æ–°å¢æ–‡ä»¶:**
- `src/api/routes/invite_codes.py` - é‚€è¯·ç  API
- `frontend/src/pages/RegisterPage.tsx` - æ³¨å†Œé¡µé¢

**ä¿®æ”¹æ–‡ä»¶:**
- `src/core/database.py` - æ·»åŠ  invite_codes è¡¨å’Œç›¸å…³æ–¹æ³•
- `src/api/routes/auth.py` - æ·»åŠ  registerã€change-password ç«¯ç‚¹
- `src/api/routes/admin.py` - æ·»åŠ  reset-password ç«¯ç‚¹
- `frontend/src/pages/AdminPage.tsx` - æ·»åŠ é‚€è¯·ç ç®¡ç† Tab
- `frontend/src/pages/SettingsPage.tsx` - æ·»åŠ å¯†ç ä¿®æ”¹è¡¨å•
- `frontend/src/components/Layout.tsx` - ä¾§è¾¹æ æ»šåŠ¨ä¿®å¤

### LLM é…ç½®ç²¾ç®€ä¸åŠŸèƒ½ä¼˜åŒ– (2024-12-25) âœ… å·²å®Œæˆ

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è”ç½‘æœç´¢ç¦ç”¨ | âœ… | æš‚æ—¶ç¦ç”¨é¢˜è§£è”ç½‘æœç´¢åŠŸèƒ½ï¼Œè·³è¿‡æ­¤ç¯èŠ‚ |
| LLM Provider ç»Ÿä¸€ | âœ… | ç”¨æˆ·åœ¨ä»»åŠ¡ç•Œé¢é€‰ä¸€ä¸ªLLMï¼Œç”Ÿæˆå’Œæ±‚è§£ç»Ÿä¸€ä½¿ç”¨ |
| ç§»é™¤ä»»åŠ¡Provideråˆ†é… | âœ… | LLMConfigPage ç§»é™¤ç®¡ç†å‘˜åˆ†é…ï¼Œç”±ç”¨æˆ·å†³å®š |
| ç§»é™¤å¹¶å‘æ§åˆ¶ | âœ… | å¹¶å‘æ§åˆ¶ç§»è‡³ã€Œå¹¶å‘ç®¡ç†ã€é¡µé¢ç»Ÿä¸€é…ç½® |
| æ¨¡å‹é…ç½®ç®€åŒ– | âœ… | ç§»é™¤ deepseek_model_generation/solutionï¼Œç»Ÿä¸€ä½¿ç”¨ deepseek_model |
| åç«¯APIæ¸…ç† | âœ… | ç§»é™¤APIè¿”å›ä¸­çš„åºŸå¼ƒå­—æ®µï¼ˆllm_provider_generation/solutionï¼‰ |
| é…ç½®å­—æ®µæ ‡è®° | âœ… | åœ¨ unified_config.py ä¸­æ ‡è®°åºŸå¼ƒå­—æ®µï¼Œä¿ç•™ä»¥å…¼å®¹æ—§æ•°æ® |
| å‰ç«¯é¡µé¢æ¸…ç† | âœ… | SettingsPage ç§»é™¤LLMé€‰æ‹©å™¨ï¼Œæ·»åŠ è¿ç§»æç¤º |
| å•å…ƒæµ‹è¯•å®Œå–„ | âœ… | æ›´æ–°æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ |

**ä¿®æ”¹æ–‡ä»¶:**
- `src/services/solution_searcher.py` - ç¦ç”¨ `_search_from_web` æ–¹æ³•ï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `src/services/task_service.py` - æ·»åŠ  `llm_provider` å­—æ®µåˆ° TaskConfigï¼Œç»Ÿä¸€è®¾ç½®ç”Ÿæˆå’Œæ±‚è§£ï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `src/api/schemas.py` - TaskCreateRequest æ·»åŠ  `llm_provider` å­—æ®µï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `src/api/routes/tasks.py` - ä¼ é€’ `llm_provider` åˆ° TaskConfigï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `src/api/routes/admin.py` - ç®€åŒ– `/llm-config` æ¥å£è¿”å›ï¼Œç§»é™¤åºŸå¼ƒå­—æ®µï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `src/api/server.py` - ç§»é™¤ `/api/config` æ¥å£ä¸­çš„åºŸå¼ƒå­—æ®µè¿”å›ï¼ˆå·²ä¿®å¤ï¼‰
- `src/services/unified_config.py` - æ ‡è®° `llm_provider_generation/solution` ä¸ºåºŸå¼ƒï¼Œä¿ç•™ä»¥å…¼å®¹æ—§æ•°æ®ï¼ˆå·²ä¿®å¤ï¼‰
- `src/services/llm/factory.py` - ç»Ÿä¸€ä½¿ç”¨å„ provider çš„å•ä¸€æ¨¡å‹ï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `frontend/src/pages/LLMConfigPage.tsx` - ç§»é™¤ä»»åŠ¡Provideråˆ†é…å’Œå¹¶å‘æ§åˆ¶ï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `frontend/src/pages/TasksPage.tsx` - æ·»åŠ ç»Ÿä¸€LLMé€‰æ‹©å™¨ï¼ˆå·²ç¡®è®¤å®Œæˆï¼‰
- `frontend/src/pages/SettingsPage.tsx` - ç§»é™¤LLM provideré€‰æ‹©å™¨ï¼Œæ·»åŠ æç¤ºä¿¡æ¯ï¼ˆå·²ä¿®å¤ï¼‰

**æ–°å¢æµ‹è¯•:**
- `tests/unit/test_llm_config.py` - LLM é…ç½®ç»Ÿä¸€æµ‹è¯•ï¼ˆå·²æ›´æ–°ï¼‰

---

## ä¸€ã€ç°çŠ¶è¯Šæ–­

### 1.1 å½“å‰æ¶æ„é—®é¢˜å›¾è°±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           OJO å½“å‰æ¶æ„é—®é¢˜å›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚  app.py     â”‚      â”‚  server.py  â”‚      â”‚ routes/*.py â”‚                â”‚
â”‚   â”‚  (å¼ƒç”¨å…¥å£)  â”‚  vs  â”‚  (å®é™…å…¥å£)  â”‚  +   â”‚ (åˆ†æ•£è·¯ç”±)  â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                   â”‚                    â”‚                         â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                              â”‚                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                    â”‚   è·¯ç”±å†²çª/é‡å¤    â”‚                                    â”‚
â”‚                    â”‚ â€¢ /api/auth/login â”‚                                    â”‚
â”‚                    â”‚ â€¢ /api/tasks      â”‚                                    â”‚
â”‚                    â”‚ â€¢ /api/adapters   â”‚                                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        é…ç½®ç³»ç»Ÿä¸‰é‡å¥                                  â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚   â”‚   â”‚ config.json â”‚ â”€â–º â”‚ unified_configâ”‚ â—„â”€â–ºâ”‚ core/config/    â”‚       â”‚  â”‚
â”‚   â”‚   â”‚  (æ–‡ä»¶)     â”‚    â”‚  (ConfigMgr) â”‚    â”‚  (ConfigCenter) â”‚       â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚   â”‚         â”‚                   â”‚                     â”‚                  â”‚  â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚   â”‚                             â”‚                                        â”‚  â”‚
â”‚   â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                               â”‚  â”‚
â”‚   â”‚                     â”‚   æ•°æ®åº“      â”‚                               â”‚  â”‚
â”‚   â”‚                     â”‚system_configs â”‚                               â”‚  â”‚
â”‚   â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        è®¤è¯ç³»ç»ŸåŒè½¨åˆ¶                                  â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   api/auth.py (bcrypt+JWT)  â‰   routes/auth.py (æ˜æ–‡å¯†ç æ¯”è¾ƒ)          â”‚  â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚  â”‚
â”‚   â”‚   get_jwt_secret_key()      â‰   get_secret_key() (ç¡¬ç¼–ç åå¤‡)          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        Pipeline åˆ†å‰æ‰§è¡Œ                              â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   server.py:execute_pipeline()     routes/tasks.py:_execute_task()  â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚   â”‚   â”‚ âœ“ user_id             â”‚       â”‚ âœ— user_id                â”‚       â”‚  â”‚
â”‚   â”‚   â”‚ âœ“ task_id             â”‚       â”‚ âœ— task_id                â”‚       â”‚  â”‚
â”‚   â”‚   â”‚ âœ“ ç”¨æˆ·é€‚é…å™¨é…ç½®        â”‚       â”‚ âœ— ç”¨æˆ·é€‚é…å™¨é…ç½®          â”‚       â”‚  â”‚
â”‚   â”‚   â”‚ âœ“ WebSocketå¹¿æ’­       â”‚       â”‚ âœ— WebSocketå¹¿æ’­          â”‚       â”‚  â”‚
â”‚   â”‚   â”‚ âœ“ æ•°æ®åº“çŠ¶æ€æ›´æ–°       â”‚       â”‚ âœ— æ•°æ®åº“çŠ¶æ€æ›´æ–°          â”‚       â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä»£ç è¡Œæ•°ç»Ÿè®¡ï¼ˆé—®é¢˜çƒ­ç‚¹ï¼‰

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ | é—®é¢˜ |
|------|------|------|------|
| `api/server.py` | 1600 | APIå…¥å£+è·¯ç”±+ä¸šåŠ¡é€»è¾‘+WebSocket | **God Object**ï¼ŒèŒè´£è¿‡å¤š |
| `services/pipeline.py` | 902 | ä»»åŠ¡æ‰§è¡Œå¼•æ“ | åˆç†ï¼Œä½†ä¸APIå±‚è€¦åˆç´§å¯† |
| `core/database.py` | 840 | æ•°æ®åº“æ“ä½œ | åˆç†ï¼Œä½†ç¼ºå°‘RepositoryæŠ½è±¡ |
| `services/unified_config.py` | 312 | é…ç½®ç®¡ç† | ä¸ `core/config/` åŠŸèƒ½é‡å  |
| `core/config/center.py` | 264 | é…ç½®ä¸­å¿ƒ | ä½¿ç”¨ç‡ä½ï¼Œæœªè¢«ä¸»æµç¨‹é‡‡ç”¨ |
| `services/oj/registry.py` | 264 | é€‚é…å™¨æ³¨å†Œ | è‰¯å¥½ï¼Œè‡ªåŠ¨å‘ç°æœºåˆ¶ |
| `services/llm/factory.py` | 253 | LLMå·¥å‚ | è‰¯å¥½ï¼Œç­–ç•¥æ¨¡å¼ |
| `services/user_context.py` | 210 | ç”¨æˆ·ä¸Šä¸‹æ–‡ | è‰¯å¥½ï¼Œçº¿ç¨‹å®‰å…¨ |

### 1.3 æ ¸å¿ƒé—®é¢˜æ¸…å•

| # | é—®é¢˜ | ä¸¥é‡åº¦ | æ ¹å›  |
|---|------|--------|------|
| 1 | APIå…¥å£æ–‡ä»¶è‡ƒè‚¿ï¼ˆ1600è¡Œï¼‰ | ğŸ”´ é«˜ | æœªéµå¾ªå•ä¸€èŒè´£åŸåˆ™ |
| 2 | é…ç½®ç³»ç»Ÿä¸‰å¥—å¹¶å­˜ | ğŸ”´ é«˜ | å†å²é—ç•™ï¼Œç¼ºä¹ç»Ÿä¸€è®¾è®¡ |
| 3 | è®¤è¯æ¨¡å—ä¸¤å¥—å®ç° | ğŸ”´ é«˜ | å¤åˆ¶ç²˜è´´ï¼Œæ¼æ´é£é™© |
| 4 | Pipelineè°ƒç”¨é“¾åˆ†å‰ | ğŸ”´ é«˜ | é‡æ„ä¸å½»åº• |
| 5 | è·¯ç”±æ³¨å†Œæ··ä¹± | ğŸŸ¡ ä¸­ | ç‰ˆæœ¬è¿­ä»£æœªæ¸…ç† |
| 6 | æ•æ„Ÿä¿¡æ¯æ˜æ–‡å­˜å‚¨ | ğŸ”´ é«˜ | å®‰å…¨æ„è¯†ä¸è¶³ |
| 7 | WebSocketç®¡ç†å™¨é‡å¤ | ğŸŸ¡ ä¸­ | æ¨¡å—åŒ–ä¸å½»åº• |
| 8 | çŠ¶æ€è¿½è¸ªåŒè½¨ | ğŸŸ¡ ä¸­ | ProblemDataManager vs DB |
| 9 | å¼‚å¸¸å¤„ç†ä¸ç»Ÿä¸€ | ğŸŸ¢ ä½ | ç¼ºä¹å…¨å±€ç­–ç•¥ |
| 10 | æµ‹è¯•è¦†ç›–ä¸è¶³ | ğŸŸ¡ ä¸­ | å¼€å‘é€Ÿåº¦ä¼˜å…ˆ |

---

## äºŒã€ç›®æ ‡æ¶æ„è®¾è®¡

### 2.1 æ¶æ„æ„¿æ™¯

**ä»ã€ŒåŠŸèƒ½å †ç Œã€åˆ°ã€Œåˆ†å±‚è§£è€¦ã€**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           OJO v9.0 ç›®æ ‡æ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         è¡¨ç°å±‚ (Presentation)                        â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  REST API   â”‚  â”‚  WebSocket  â”‚  â”‚   CLI       â”‚  â”‚  (GUI?)   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  /api/*     â”‚  â”‚  /ws        â”‚  â”‚  argparse   â”‚  â”‚           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                â”‚                â”‚               â”‚             â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                             â”‚                â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         åº”ç”¨å±‚ (Application)                         â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚   TaskService   â”‚  â”‚  AuthService    â”‚  â”‚  AdminService   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚   (ä»»åŠ¡ç¼–æ’)     â”‚  â”‚  (è®¤è¯æˆæƒ)     â”‚  â”‚  (ç®¡ç†åŠŸèƒ½)      â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚           â”‚                    â”‚                    â”‚               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚                       â”‚                 â”‚     â”‚   â”‚
â”‚  â””â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜   â”‚
â”‚     â”‚                 â”‚                       â”‚                 â”‚          â”‚
â”‚  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         é¢†åŸŸå±‚ (Domain)                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ PipelineEngineâ”‚  â”‚  UserContext  â”‚  â”‚  EventBus     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚   (æ‰§è¡Œå¼•æ“)   â”‚  â”‚  (ç”¨æˆ·ä¸Šä¸‹æ–‡)  â”‚  â”‚  (äº‹ä»¶é©±åŠ¨)   â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚          â”‚                                     â”‚                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚              é¢†åŸŸæœåŠ¡ (Domain Services)              â”‚           â”‚   â”‚
â”‚  â”‚  â”‚                                                     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â”‚Generator â”‚ â”‚ Uploader â”‚ â”‚  Solver  â”‚ â”‚Trainer â”‚ â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Repository â”‚  â”‚  LLMClient â”‚  â”‚ OJAdapter  â”‚  â”‚   Config   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (æ•°æ®è®¿é—®) â”‚  â”‚  (AIè°ƒç”¨)  â”‚  â”‚  (OJäº¤äº’)  â”‚  â”‚  (é…ç½®)    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                    æ•°æ®åº“ / æ–‡ä»¶ç³»ç»Ÿ / å¤–éƒ¨API                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

| åŸåˆ™ | æè¿° | è½åœ°æªæ–½ |
|------|------|---------|
| **å•ä¸€å…¥å£** | åªæœ‰ä¸€ä¸ª API å…¥å£æ–‡ä»¶ | åˆ é™¤ `app.py`ï¼Œç²¾ç®€ `server.py` |
| **å•ä¸€é…ç½®æº** | æ•°æ®åº“æ˜¯å”¯ä¸€çœŸç›¸ | åºŸå¼ƒ `config.json` åŒå†™ |
| **å…³æ³¨ç‚¹åˆ†ç¦»** | è·¯ç”±ã€ä¸šåŠ¡ã€æ•°æ®è®¿é—®åˆ†ç¦» | å¼•å…¥ Service å±‚ |
| **ä¾èµ–æ³¨å…¥** | æœåŠ¡é€šè¿‡ DI è·å–ä¾èµ– | ä½¿ç”¨ FastAPI Depends |
| **äº‹ä»¶é©±åŠ¨** | çŠ¶æ€å˜æ›´é€šè¿‡äº‹ä»¶é€šçŸ¥ | ç»Ÿä¸€ä½¿ç”¨ EventBus |
| **ç”¨æˆ·éš”ç¦»** | å¤šç§Ÿæˆ·æ•°æ®éš”ç¦» | UserContext è´¯ç©¿å…¨é“¾è·¯ |

---

## ä¸‰ã€é‡æ„æ–¹æ¡ˆè¯¦è§£

### 3.1 API å±‚é‡æ„

#### 3.1.1 ç›®å½•ç»“æ„é‡ç»„

```
src/api/                          # API å±‚ï¼ˆè¡¨ç°å±‚ï¼‰
â”œâ”€â”€ __init__.py                   # FastAPI app åˆ›å»º
â”œâ”€â”€ main.py                       # uvicorn å…¥å£
â”œâ”€â”€ dependencies.py               # ä¾èµ–æ³¨å…¥å®šä¹‰
â”œâ”€â”€ exceptions.py                 # å¼‚å¸¸å¤„ç†å™¨
â”œâ”€â”€ middleware/                   # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cors.py                   # CORS é…ç½®
â”‚   â”œâ”€â”€ auth.py                   # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ logging.py                # è¯·æ±‚æ—¥å¿—
â”œâ”€â”€ routes/                       # è·¯ç”±ï¼ˆçº¯è·¯ç”±ï¼Œæ— ä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ __init__.py               # è·¯ç”±æ³¨å†Œ
â”‚   â”œâ”€â”€ auth.py                   # è®¤è¯è·¯ç”± (/api/auth/*)
â”‚   â”œâ”€â”€ tasks.py                  # ä»»åŠ¡è·¯ç”± (/api/tasks/*)
â”‚   â”œâ”€â”€ adapters.py               # é€‚é…å™¨è·¯ç”± (/api/adapters/*)
â”‚   â”œâ”€â”€ admin.py                  # ç®¡ç†è·¯ç”± (/api/admin/*)
â”‚   â”œâ”€â”€ config.py                 # é…ç½®è·¯ç”± (/api/config/*)
â”‚   â””â”€â”€ websocket.py              # WebSocket è·¯ç”± (/ws)
â””â”€â”€ schemas/                      # è¯·æ±‚/å“åº”æ¨¡å‹
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ auth.py
    â”œâ”€â”€ tasks.py
    â””â”€â”€ common.py
```

#### 3.1.2 ç»Ÿä¸€å…¥å£è®¾è®¡

```python
# src/api/__init__.py
from fastapi import FastAPI
from contextlib import asynccontextmanager

from .middleware import setup_middleware
from .routes import register_routes
from .exceptions import register_exception_handlers

@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    # å¯åŠ¨æ—¶
    from core.events import get_event_bus
    from services.task_service import TaskService
    
    event_bus = get_event_bus()
    await event_bus.start()
    
    yield
    
    # å…³é—­æ—¶
    await event_bus.stop()

def create_app() -> FastAPI:
    """åˆ›å»º FastAPI åº”ç”¨ï¼ˆå”¯ä¸€å…¥å£ï¼‰"""
    app = FastAPI(
        title="OJO API",
        version="9.0.0",
        lifespan=lifespan
    )
    
    setup_middleware(app)
    register_routes(app)
    register_exception_handlers(app)
    
    return app

app = create_app()
```

#### 3.1.3 è·¯ç”±æ–‡ä»¶ç˜¦èº«åŸåˆ™

```python
# src/api/routes/tasks.py - ç¤ºä¾‹ï¼ˆç›®æ ‡ï¼š<100è¡Œï¼‰
from fastapi import APIRouter, Depends, BackgroundTasks
from typing import List

from ..dependencies import get_current_user, get_task_service
from ..schemas.tasks import TaskCreateRequest, TaskResponse
from services.task_service import TaskService

router = APIRouter(prefix="/api/tasks", tags=["tasks"])

@router.post("/", response_model=TaskResponse)
async def create_task(
    request: TaskCreateRequest,
    background_tasks: BackgroundTasks,
    current_user: dict = Depends(get_current_user),
    task_service: TaskService = Depends(get_task_service)
):
    """åˆ›å»ºä»»åŠ¡ - è·¯ç”±åªåšå‚æ•°ä¼ é€’ï¼Œä¸šåŠ¡é€»è¾‘åœ¨ Service"""
    return await task_service.create_and_execute(
        user_id=current_user["user_id"],
        problem_ids=request.problem_ids,
        config=request.to_config(),
        background_tasks=background_tasks
    )

@router.get("/")
async def list_tasks(
    current_user: dict = Depends(get_current_user),
    task_service: TaskService = Depends(get_task_service),
    search: str = None,
    status: str = None,
    limit: int = 100
):
    """è·å–ä»»åŠ¡åˆ—è¡¨"""
    return await task_service.get_user_tasks(
        user_id=current_user["user_id"],
        search=search,
        status=status,
        limit=limit
    )
```

---

### 3.2 Service å±‚å¼•å…¥

#### 3.2.1 æœåŠ¡å±‚è®¾è®¡

```python
# src/services/task_service.py - æ–°å¢
from typing import List, Dict, Any, Optional
from fastapi import BackgroundTasks
from loguru import logger

from core.database import Database
from core.events import EventBus, TaskEvent, EventType
from services.pipeline import PipelineRunner
from services.user_context import UserContext

class TaskService:
    """
    ä»»åŠ¡æœåŠ¡ - ä¸šåŠ¡é€»è¾‘èšåˆ
    
    èŒè´£ï¼š
    1. ä»»åŠ¡åˆ›å»ºä¸æŒä¹…åŒ–
    2. ä»»åŠ¡æ‰§è¡Œè°ƒåº¦
    3. çŠ¶æ€åŒæ­¥ï¼ˆDB + Eventï¼‰
    4. ç”¨æˆ·éš”ç¦»
    """
    
    def __init__(
        self, 
        db: Database,
        event_bus: EventBus,
        config_service: ConfigService
    ):
        self.db = db
        self.event_bus = event_bus
        self.config_service = config_service
    
    async def create_and_execute(
        self,
        user_id: int,
        problem_ids: List[str],
        config: Dict[str, Any],
        background_tasks: BackgroundTasks
    ) -> Dict:
        """åˆ›å»ºä»»åŠ¡å¹¶åœ¨åå°æ‰§è¡Œ"""
        
        # 1. åˆ›å»ºä»»åŠ¡è®°å½•
        tasks = []
        for pid in problem_ids:
            task_id = self.db.create_task(
                user_id=user_id,
                problem_id=pid,
                source_oj=config.get("source_adapter"),
                target_oj=config.get("target_adapter")
            )
            tasks.append({"id": task_id, "problem_id": pid})
        
        # 2. æ·»åŠ åå°æ‰§è¡Œ
        background_tasks.add_task(
            self._execute_tasks,
            tasks,
            config,
            user_id
        )
        
        # 3. å‘å¸ƒåˆ›å»ºäº‹ä»¶
        await self.event_bus.publish(TaskEvent(
            type=EventType.TASK_CREATED,
            task_id=str(tasks[0]["id"]) if tasks else "",
            data={"count": len(tasks), "user_id": user_id}
        ))
        
        return {"tasks": tasks, "status": "created"}
    
    async def _execute_tasks(
        self, 
        tasks: List[Dict],
        config: Dict,
        user_id: int
    ):
        """åå°æ‰§è¡Œä»»åŠ¡ï¼ˆç»Ÿä¸€æ‰§è¡Œå…¥å£ï¼‰"""
        
        # åŠ è½½ç”¨æˆ·é…ç½®
        cfg_mgr = self.config_service.get_manager()
        user_adapter_configs = self.db.get_all_user_adapter_configs(user_id)
        if user_adapter_configs:
            cfg_mgr.cfg.adapter_configs = user_adapter_configs
        
        for task_info in tasks:
            task_id = task_info["id"]
            problem_id = task_info["problem_id"]
            
            try:
                # æ›´æ–°çŠ¶æ€
                self.db.update_task(task_id, status=1, stage="running")
                
                await self.event_bus.publish(TaskEvent(
                    type=EventType.TASK_STARTED,
                    task_id=str(task_id),
                    problem_id=problem_id
                ))
                
                # åˆ›å»º Pipelineï¼ˆå¸¦ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼‰
                pipeline = PipelineRunner(
                    cfg_mgr=cfg_mgr,
                    user_id=user_id,
                    task_id=task_id  # å…³é”®ï¼šä¼ å…¥ task_id
                )
                
                # æ‰§è¡Œ
                result = pipeline.run_single(problem_id, config)
                
                # æ›´æ–°ç»“æœ
                if result.ok_solve or result.ok_upload:
                    self.db.update_task(
                        task_id, 
                        status=4, 
                        stage="completed",
                        uploaded_url=result.extra.get("uploaded_url")
                    )
                    await self.event_bus.publish(TaskEvent(
                        type=EventType.TASK_COMPLETED,
                        task_id=str(task_id)
                    ))
                else:
                    self.db.update_task(task_id, status=-1, stage="failed")
                    await self.event_bus.publish(TaskEvent(
                        type=EventType.TASK_FAILED,
                        task_id=str(task_id)
                    ))
                    
            except Exception as e:
                logger.exception(f"ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {task_id}")
                self.db.update_task(
                    task_id, 
                    status=-1, 
                    stage="failed",
                    error_message=str(e)
                )
```

#### 3.2.2 æœåŠ¡æ³¨å†Œè¡¨

```python
# src/services/__init__.py
from functools import lru_cache
from core.database import get_database
from core.events import get_event_bus

@lru_cache()
def get_task_service():
    """è·å–ä»»åŠ¡æœåŠ¡å•ä¾‹"""
    from .task_service import TaskService
    from .config_service import get_config_service
    return TaskService(
        db=get_database(),
        event_bus=get_event_bus(),
        config_service=get_config_service()
    )

@lru_cache()
def get_auth_service():
    """è·å–è®¤è¯æœåŠ¡å•ä¾‹"""
    from .auth_service import AuthService
    return AuthService(db=get_database())

@lru_cache()
def get_adapter_service():
    """è·å–é€‚é…å™¨æœåŠ¡å•ä¾‹"""
    from .adapter_service import AdapterService
    return AdapterService()
```

---

### 3.3 é…ç½®ç³»ç»Ÿç»Ÿä¸€

#### 3.3.1 åºŸå¼ƒç­–ç•¥

```
å½“å‰çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚   config.json â”€â”€â”¬â”€â”€â–º unified_config.py â”€â”€â–º AppConfig            â”‚
â”‚                 â”‚         â–²                                     â”‚
â”‚                 â””â”€â”€â–º database â—„â”€â”€â”€ core/config/center.py        â”‚
â”‚                                        (å‡ ä¹æœªä½¿ç”¨)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚   config.json â”€â”€â”¬â”€â”€â–º (é¦–æ¬¡è¿ç§»ååˆ é™¤)                            â”‚
â”‚                 â”‚                                               â”‚
â”‚                 â–¼                                               â”‚
â”‚   database.system_configs â”€â”€â–º ConfigService â”€â”€â–º AppConfig       â”‚
â”‚         å”¯ä¸€çœŸç›¸æº                                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 ConfigService è®¾è®¡

```python
# src/services/config_service.py - é‡æ„å
from typing import Any, Dict, Optional
from dataclasses import dataclass, asdict, field
from core.database import Database
from loguru import logger

@dataclass
class AppConfig:
    """åº”ç”¨é…ç½®ï¼ˆå•ä¸€å®šä¹‰ï¼‰"""
    # ... æ‰€æœ‰é…ç½®å­—æ®µï¼ˆä¸ç°æœ‰ç›¸åŒï¼‰
    
    def to_safe_dict(self) -> Dict:
        """å¯¼å‡ºå®‰å…¨é…ç½®ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰"""
        data = asdict(self)
        sensitive_keys = ['api_key', 'password', 'token', 'sid', 'cookie']
        for key in list(data.keys()):
            if any(s in key.lower() for s in sensitive_keys):
                data[f"{key}_configured"] = bool(data[key])
                data[key] = "***" if data[key] else ""
        return data

class ConfigService:
    """
    é…ç½®æœåŠ¡ - å”¯ä¸€é…ç½®ç®¡ç†å…¥å£
    
    ç‰¹æ€§ï¼š
    1. æ•°æ®åº“ä¸ºå”¯ä¸€å­˜å‚¨
    2. æ”¯æŒç”¨æˆ·çº§é…ç½®è¦†ç›–
    3. é…ç½®å˜æ›´äº‹ä»¶é€šçŸ¥
    """
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        if hasattr(self, '_initialized'):
            return
        self._initialized = True
        self._db: Database = None
        self._config: Optional[AppConfig] = None
        self._user_overrides: Dict[int, Dict] = {}
    
    def initialize(self, db: Database):
        """åˆå§‹åŒ–ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰"""
        self._db = db
        self._load_config()
    
    def _load_config(self):
        """ä»æ•°æ®åº“åŠ è½½é…ç½®"""
        db_config = self._db.get_system_config("app_config") or {}
        self._config = AppConfig(**{
            **asdict(AppConfig()),  # é»˜è®¤å€¼
            **db_config  # æ•°æ®åº“å€¼è¦†ç›–
        })
    
    def get(self, user_id: int = None) -> AppConfig:
        """è·å–é…ç½®ï¼ˆæ”¯æŒç”¨æˆ·è¦†ç›–ï¼‰"""
        if user_id and user_id in self._user_overrides:
            # åˆå¹¶ç”¨æˆ·è¦†ç›–
            base = asdict(self._config)
            base.update(self._user_overrides[user_id])
            return AppConfig(**base)
        return self._config
    
    def update(self, key: str, value: Any) -> None:
        """æ›´æ–°é…ç½®ï¼ˆåªå†™æ•°æ®åº“ï¼Œä¸å†™æ–‡ä»¶ï¼‰"""
        if hasattr(self._config, key):
            setattr(self._config, key, value)
            
            # ä¿å­˜åˆ°æ•°æ®åº“
            self._db.set_system_config("app_config", asdict(self._config))
            
            # å‘å¸ƒå˜æ›´äº‹ä»¶
            from core.events import get_event_bus, SystemEvent, EventType
            get_event_bus().publish_sync(SystemEvent(
                type=EventType.CONFIG_CHANGED,
                data={"key": key, "value": value}
            ))
    
    def set_user_override(self, user_id: int, overrides: Dict):
        """è®¾ç½®ç”¨æˆ·çº§é…ç½®è¦†ç›–"""
        self._user_overrides[user_id] = overrides

def get_config_service() -> ConfigService:
    return ConfigService()
```

---

### 3.4 è®¤è¯ç³»ç»Ÿç»Ÿä¸€

#### 3.4.1 å•ä¸€è®¤è¯æ¨¡å—

```python
# src/services/auth_service.py - ç»Ÿä¸€è®¤è¯æœåŠ¡
import bcrypt
import jwt
import secrets
from datetime import datetime, timedelta
from typing import Dict, Optional
from core.database import Database
from loguru import logger

class AuthService:
    """
    è®¤è¯æœåŠ¡ - å”¯ä¸€è®¤è¯å…¥å£
    
    ç‰¹æ€§ï¼š
    1. bcrypt å¯†ç å“ˆå¸Œ
    2. JWT Token ç­¾å‘/éªŒè¯
    3. ç™»å½•é¢‘ç‡é™åˆ¶
    4. å¯†é’¥å®‰å…¨ç®¡ç†
    """
    
    JWT_ALGORITHM = "HS256"
    JWT_EXPIRATION_HOURS = 24 * 7
    
    def __init__(self, db: Database):
        self.db = db
        self._jwt_secret: Optional[str] = None
        self._rate_limiter = RateLimiter()
    
    @property
    def jwt_secret(self) -> str:
        """è·å– JWT å¯†é’¥ï¼ˆæ‡’åŠ è½½ï¼Œä¼˜å…ˆæ•°æ®åº“ï¼‰"""
        if self._jwt_secret:
            return self._jwt_secret
        
        # 1. ä»æ•°æ®åº“è·å–
        self._jwt_secret = self.db.get_system_config("jwt_secret_key")
        if self._jwt_secret:
            return self._jwt_secret
        
        # 2. ç”Ÿæˆæ–°å¯†é’¥å¹¶å­˜å‚¨
        self._jwt_secret = secrets.token_urlsafe(32)
        self.db.set_system_config("jwt_secret_key", self._jwt_secret)
        logger.info("ç”Ÿæˆæ–°çš„ JWT å¯†é’¥")
        
        return self._jwt_secret
    
    def hash_password(self, password: str) -> str:
        """å¯†ç å“ˆå¸Œ"""
        return bcrypt.hashpw(
            password.encode('utf-8'), 
            bcrypt.gensalt()
        ).decode('utf-8')
    
    def verify_password(self, password: str, hashed: str) -> bool:
        """å¯†ç éªŒè¯"""
        try:
            return bcrypt.checkpw(
                password.encode('utf-8'), 
                hashed.encode('utf-8')
            )
        except Exception:
            return False
    
    def create_token(self, user_id: int, username: str, role: str) -> str:
        """åˆ›å»º JWT Token"""
        payload = {
            "sub": str(user_id),
            "username": username,
            "role": role,
            "exp": datetime.utcnow() + timedelta(hours=self.JWT_EXPIRATION_HOURS),
            "iat": datetime.utcnow()
        }
        return jwt.encode(payload, self.jwt_secret, algorithm=self.JWT_ALGORITHM)
    
    def verify_token(self, token: str) -> Dict:
        """éªŒè¯ JWT Token"""
        payload = jwt.decode(
            token, 
            self.jwt_secret, 
            algorithms=[self.JWT_ALGORITHM]
        )
        return {
            "user_id": int(payload["sub"]),
            "username": payload["username"],
            "role": payload["role"]
        }
    
    async def login(self, username: str, password: str) -> Dict:
        """ç™»å½•"""
        # é¢‘ç‡é™åˆ¶æ£€æŸ¥
        if not self._rate_limiter.allow(username):
            raise RateLimitExceeded("ç™»å½•å°è¯•è¿‡äºé¢‘ç¹")
        
        # è·å–ç”¨æˆ·
        user = self.db.get_user_by_username(username)
        if not user:
            self._rate_limiter.record_failure(username)
            raise InvalidCredentials()
        
        # éªŒè¯å¯†ç ï¼ˆç»Ÿä¸€ä½¿ç”¨ bcryptï¼‰
        if not self.verify_password(password, user["password"]):
            self._rate_limiter.record_failure(username)
            raise InvalidCredentials()
        
        # æ£€æŸ¥çŠ¶æ€
        if user.get("status") != "active":
            raise UserDisabled()
        
        # ç”Ÿæˆ Token
        self._rate_limiter.record_success(username)
        self.db.update_last_login(user["id"])
        
        return {
            "token": self.create_token(user["id"], user["username"], user["role"]),
            "user": {
                "id": user["id"],
                "username": user["username"],
                "role": user["role"]
            }
        }
```

#### 3.4.2 åˆ é™¤é‡å¤ä»£ç 

```python
# éœ€è¦åˆ é™¤/åˆå¹¶çš„ä»£ç ï¼š

# 1. api/routes/auth.py:24-72 - åˆ é™¤é‡å¤çš„ JWT å‡½æ•°
#    æ”¹ä¸ºå¯¼å…¥ AuthService

# 2. api/routes/auth.py:115-119 - åˆ é™¤æ˜æ–‡å¯†ç æ¯”è¾ƒ
#    æ”¹ä¸ºä½¿ç”¨ AuthService.verify_password()

# 3. api/auth.py:26-58 - ä¿ç•™ï¼Œä½†é‡æ„ä¸º AuthService å†…éƒ¨æ–¹æ³•
```

---

### 3.5 Pipeline æ‰§è¡Œé“¾ç»Ÿä¸€

#### 3.5.1 ç»Ÿä¸€æ‰§è¡Œå…¥å£

```python
# src/services/pipeline.py - ä¿®æ”¹

class PipelineRunner:
    """Pipeline æ‰§è¡Œå™¨"""
    
    def __init__(
        self, 
        cfg_mgr: ConfigManager,
        user_id: int,
        task_id: int,  # å¿…ä¼ ï¼Œä¸å†æ˜¯ Optional
        ...
    ):
        self._user_id = user_id
        self._task_id = task_id  # å§‹ç»ˆæœ‰å€¼
        self._db = get_database()
        ...
    
    def _update_stage(self, pid: str, stage: str, **kwargs):
        """æ›´æ–°å¤„ç†é˜¶æ®µï¼ˆç»Ÿä¸€æ›´æ–°æœ¬åœ°+æ•°æ®åº“ï¼‰"""
        # æœ¬åœ°çŠ¶æ€
        pdir = self._problem_dir_for(pid)
        ProblemDataManager.set_processing_status(pdir, {"stage": stage, **kwargs})
        
        # æ•°æ®åº“çŠ¶æ€ï¼ˆå§‹ç»ˆæ›´æ–°ï¼‰
        self._db.update_task(self._task_id, stage=stage, **kwargs)
        
        # äº‹ä»¶é€šçŸ¥
        self.event_bus.publish_sync(TaskEvent(
            type=EventType.TASK_PROGRESS,
            task_id=str(self._task_id),
            problem_id=pid,
            stage=stage,
            data={"stage": stage, **kwargs}
        ))
```

#### 3.5.2 åºŸå¼ƒæ—§æ‰§è¡Œå…¥å£

```python
# éœ€è¦åˆ é™¤çš„ä»£ç ï¼š

# api/routes/tasks.py:190-219 - _execute_task()
# api/routes/tasks.py:222-251 - _execute_retry()
# 
# è¿™äº›å‡½æ•°ç»•è¿‡äº†ç”¨æˆ·éš”ç¦»æœºåˆ¶ï¼Œå¿…é¡»åºŸå¼ƒ
# æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»Ÿä¸€èµ° TaskService
```

---

### 3.6 çŠ¶æ€è¿½è¸ªç»Ÿä¸€

#### 3.6.1 åŒå†™ç­–ç•¥

```
å½“å‰é—®é¢˜ï¼š
- ProblemDataManager å†™æœ¬åœ° JSON
- Database å†™ SQLite tasks è¡¨
- ä¸¤è€…å¯èƒ½ä¸ä¸€è‡´

è§£å†³æ–¹æ¡ˆï¼š
- ProblemDataManager ä½œä¸ºã€Œè¯¦ç»†æ—¥å¿—ã€ï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰
- Database tasks è¡¨ä½œä¸ºã€ŒçŠ¶æ€çœŸç›¸ã€ï¼ˆå¿…é¡»ï¼‰
- å‰ç«¯åªæŸ¥è¯¢ Database

çŠ¶æ€æµå‘ï¼š
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Pipeline._update_stage â”€â”¤               â”œâ”€â–º ProblemDataManager (å¯é€‰è¯¦æƒ…)
                        â”‚  ç»Ÿä¸€å…¥å£     â”‚
                        â”‚               â”œâ”€â–º Database.update_task (çŠ¶æ€çœŸç›¸)
                        â”‚               â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â–º EventBus (å®æ—¶é€šçŸ¥)
```

---

### 3.7 æ•æ„Ÿä¿¡æ¯åŠ å¯†

#### 3.7.1 åŠ å¯†å­˜å‚¨æ–¹æ¡ˆ

```python
# src/services/secret_service.py - æ–°å¢
from cryptography.fernet import Fernet
from typing import Optional
import os
import base64

class SecretService:
    """
    æ•æ„Ÿä¿¡æ¯åŠ å¯†æœåŠ¡
    
    åŠ å¯†å¯¹è±¡ï¼šAPI Keyã€å¯†ç ã€Cookieã€Token
    """
    
    def __init__(self, db):
        self.db = db
        self._cipher: Optional[Fernet] = None
    
    @property
    def cipher(self) -> Fernet:
        """è·å–åŠ å¯†å™¨ï¼ˆæ‡’åŠ è½½ï¼‰"""
        if self._cipher:
            return self._cipher
        
        # ä»æ•°æ®åº“æˆ–ç¯å¢ƒå˜é‡è·å–å¯†é’¥
        key = self.db.get_system_config("encryption_key")
        if not key:
            key = os.getenv("OJO_ENCRYPTION_KEY")
        if not key:
            # ç”Ÿæˆæ–°å¯†é’¥
            key = Fernet.generate_key().decode()
            self.db.set_system_config("encryption_key", key)
        
        self._cipher = Fernet(key.encode())
        return self._cipher
    
    def encrypt(self, plaintext: str) -> str:
        """åŠ å¯†"""
        if not plaintext:
            return ""
        return self.cipher.encrypt(plaintext.encode()).decode()
    
    def decrypt(self, ciphertext: str) -> str:
        """è§£å¯†"""
        if not ciphertext:
            return ""
        try:
            return self.cipher.decrypt(ciphertext.encode()).decode()
        except Exception:
            # è§£å¯†å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æ—§çš„æ˜æ–‡æ•°æ®ï¼‰
            return ciphertext

# ä½¿ç”¨ç¤ºä¾‹
# ä¿å­˜é€‚é…å™¨é…ç½®æ—¶
def save_adapter_config(user_id, adapter_name, config):
    secret_svc = get_secret_service()
    
    # åŠ å¯†æ•æ„Ÿå­—æ®µ
    sensitive_keys = ['password', 'token', 'api_key', 'cookie', 'sid']
    for key in sensitive_keys:
        if key in config and config[key]:
            config[key] = secret_svc.encrypt(config[key])
    
    db.save_user_adapter_config(user_id, adapter_name, config)
```

---

### 3.8 WebSocket ç»Ÿä¸€

#### 3.8.1 åˆå¹¶ç®¡ç†å™¨

```python
# src/api/websocket/manager.py - ç»Ÿä¸€ WebSocket ç®¡ç†
from typing import Set, Dict
from fastapi import WebSocket
import asyncio
import json
from loguru import logger

from core.events import get_event_bus, Event

class WebSocketManager:
    """
    WebSocket è¿æ¥ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
    
    èŒè´£ï¼š
    1. è¿æ¥ç®¡ç†
    2. äº‹ä»¶è®¢é˜…ä¸å¹¿æ’­
    3. ç”¨æˆ·çº§æ¶ˆæ¯è¿‡æ»¤
    """
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        if hasattr(self, '_initialized'):
            return
        self._initialized = True
        
        # è¿æ¥æ± ï¼š{user_id: Set[WebSocket]}
        self._connections: Dict[int, Set[WebSocket]] = {}
        # åŒ¿åè¿æ¥
        self._anonymous: Set[WebSocket] = set()
        
        # è®¢é˜…äº‹ä»¶æ€»çº¿
        self._subscribe_events()
    
    def _subscribe_events(self):
        """è®¢é˜…äº‹ä»¶æ€»çº¿"""
        event_bus = get_event_bus()
        event_bus.subscribe("*", self._on_event)
    
    async def _on_event(self, event: Event):
        """äº‹ä»¶å¤„ç† â†’ å¹¿æ’­"""
        message = {
            "type": event.type.value if hasattr(event.type, 'value') else str(event.type),
            "timestamp": event.timestamp.isoformat() if hasattr(event, 'timestamp') else None,
            "data": event.data
        }
        
        # å¦‚æœäº‹ä»¶åŒ…å« user_idï¼Œåªå‘ç»™è¯¥ç”¨æˆ·
        user_id = event.data.get("user_id")
        if user_id:
            await self._send_to_user(user_id, message)
        else:
            await self.broadcast(message)
    
    async def connect(self, websocket: WebSocket, user_id: int = None):
        """è¿æ¥"""
        await websocket.accept()
        
        if user_id:
            if user_id not in self._connections:
                self._connections[user_id] = set()
            self._connections[user_id].add(websocket)
        else:
            self._anonymous.add(websocket)
        
        logger.info(f"WebSocket è¿æ¥: user={user_id}, total={self.connection_count}")
    
    def disconnect(self, websocket: WebSocket, user_id: int = None):
        """æ–­å¼€"""
        if user_id and user_id in self._connections:
            self._connections[user_id].discard(websocket)
        self._anonymous.discard(websocket)
        
        logger.info(f"WebSocket æ–­å¼€: user={user_id}, total={self.connection_count}")
    
    async def _send_to_user(self, user_id: int, message: dict):
        """å‘é€ç»™ç‰¹å®šç”¨æˆ·"""
        connections = self._connections.get(user_id, set())
        await self._send_to_connections(connections, message)
    
    async def broadcast(self, message: dict):
        """å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥"""
        all_connections = self._anonymous.copy()
        for conns in self._connections.values():
            all_connections.update(conns)
        await self._send_to_connections(all_connections, message)
    
    async def _send_to_connections(self, connections: Set[WebSocket], message: dict):
        """å‘é€ç»™æŒ‡å®šè¿æ¥é›†åˆ"""
        message_str = json.dumps(message, ensure_ascii=False, default=str)
        dead = set()
        
        for ws in connections:
            try:
                await ws.send_text(message_str)
            except Exception:
                dead.add(ws)
        
        # æ¸…ç†æ­»è¿æ¥
        for ws in dead:
            for user_conns in self._connections.values():
                user_conns.discard(ws)
            self._anonymous.discard(ws)
    
    @property
    def connection_count(self) -> int:
        return len(self._anonymous) + sum(len(c) for c in self._connections.values())

def get_ws_manager() -> WebSocketManager:
    return WebSocketManager()
```

---

## å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 4.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | æè¿° |
|------|------|
| `src/api/__init__.py` | ç»Ÿä¸€åº”ç”¨å…¥å£ |
| `src/api/dependencies.py` | ä¾èµ–æ³¨å…¥ |
| `src/api/middleware/__init__.py` | ä¸­é—´ä»¶åŒ… |
| `src/api/middleware/cors.py` | CORS é…ç½® |
| `src/api/middleware/auth.py` | è®¤è¯ä¸­é—´ä»¶ |
| `src/api/schemas/__init__.py` | Schema åŒ… |
| `src/api/schemas/tasks.py` | ä»»åŠ¡ Schema |
| `src/api/schemas/auth.py` | è®¤è¯ Schema |
| `src/api/websocket/manager.py` | WS ç®¡ç†å™¨ |
| `src/services/task_service.py` | ä»»åŠ¡æœåŠ¡ |
| `src/services/auth_service.py` | è®¤è¯æœåŠ¡ |
| `src/services/config_service.py` | é…ç½®æœåŠ¡ |
| `src/services/secret_service.py` | åŠ å¯†æœåŠ¡ |

### 4.2 åˆ é™¤æ–‡ä»¶

| æ–‡ä»¶ | åŸå›  |
|------|------|
| `src/api/app.py` | ä¸ server.py é‡å¤ |
| `src/core/config/center.py` | æœªè¢«ä½¿ç”¨ï¼Œä¸ unified_config åŠŸèƒ½é‡å  |

### 4.3 é‡æ„æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `src/api/server.py` | ç²¾ç®€åˆ° <200 è¡Œï¼Œåªä¿ç•™åº”ç”¨ç»„è£… |
| `src/api/routes/auth.py` | åˆ é™¤é‡å¤å‡½æ•°ï¼Œä½¿ç”¨ AuthService |
| `src/api/routes/tasks.py` | åˆ é™¤ä¸šåŠ¡é€»è¾‘ï¼Œåªä¿ç•™è·¯ç”± |
| `src/services/pipeline.py` | task_id å¿…ä¼ ï¼Œç»Ÿä¸€çŠ¶æ€æ›´æ–° |
| `src/services/unified_config.py` | ç§»é™¤ config.json åŒå†™ |
| `src/core/database.py` | æ·»åŠ åŠ å¯†å­—æ®µæ”¯æŒ |

### 4.4 é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `config.json` | æ·»åŠ åˆ° .gitignoreï¼Œæä¾› config.example.json |
| `.env.example` | æ–°å¢ OJO_ENCRYPTION_KEY è¯´æ˜ |
| `requirements.txt` | æ–°å¢ cryptography |

---

## äº”ã€å®æ–½è·¯çº¿å›¾

### Phase 1: ç´§æ€¥å®‰å…¨ä¿®å¤ï¼ˆ1å¤©ï¼‰

```
â–¡ ä¿®å¤ routes/auth.py æ˜æ–‡å¯†ç æ¯”è¾ƒ
â–¡ ç§»é™¤ database.py å¯†ç æ—¥å¿—è¾“å‡º
â–¡ æ·»åŠ  config.json åˆ° .gitignore
```

### Phase 2: è®¤è¯ç³»ç»Ÿç»Ÿä¸€ï¼ˆ2å¤©ï¼‰

```
â–¡ åˆ›å»º AuthService
â–¡ è¿ç§» api/auth.py å‡½æ•°åˆ° AuthService
â–¡ ä¿®æ”¹æ‰€æœ‰è·¯ç”±ä½¿ç”¨ AuthService
â–¡ åˆ é™¤ routes/auth.py é‡å¤ä»£ç 
```

### Phase 3: é…ç½®ç³»ç»Ÿç»Ÿä¸€ï¼ˆ2å¤©ï¼‰

```
â–¡ åˆ›å»º ConfigService
â–¡ ç§»é™¤ config.json åŒå†™é€»è¾‘
â–¡ åˆ é™¤ core/config/center.py
â–¡ ç»Ÿä¸€ä½¿ç”¨ ConfigService
```

### Phase 4: Service å±‚å¼•å…¥ï¼ˆ3å¤©ï¼‰

```
â–¡ åˆ›å»º TaskService
â–¡ è¿ç§» server.py ä¸šåŠ¡é€»è¾‘åˆ° TaskService
â–¡ åˆ é™¤ routes/tasks.py çš„ _execute_task
â–¡ è·¯ç”±å±‚ç˜¦èº«
```

### Phase 5: API å±‚é‡æ„ï¼ˆ2å¤©ï¼‰

```
â–¡ åˆ é™¤ app.py
â–¡ ç²¾ç®€ server.py
â–¡ ç»Ÿä¸€ WebSocket ç®¡ç†å™¨
â–¡ ä¸­é—´ä»¶æ¨¡å—åŒ–
```

### Phase 6: åŠ å¯†å­˜å‚¨ï¼ˆ1å¤©ï¼‰

```
â–¡ åˆ›å»º SecretService
â–¡ è¿ç§»æ•æ„Ÿæ•°æ®åŠ å¯†
â–¡ æ·»åŠ è¿ç§»è„šæœ¬
```

### Phase 7: æµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ2å¤©ï¼‰

```
â–¡ æ ¸å¿ƒæ¨¡å—å•æµ‹
â–¡ é›†æˆæµ‹è¯•
â–¡ API æ–‡æ¡£æ›´æ–°
â–¡ éƒ¨ç½²æ–‡æ¡£æ›´æ–°
```

---

## å…­ã€é£é™©è¯„ä¼°

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|---------|
| é‡æ„å¼•å…¥ Bug | é«˜ | é«˜ | åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µå®Œæ•´æµ‹è¯• |
| é…ç½®è¿ç§»ä¸¢å¤± | ä¸­ | é«˜ | å¤‡ä»½ç°æœ‰æ•°æ®åº“ï¼Œæä¾›å›æ»šè„šæœ¬ |
| è®¤è¯å…¼å®¹æ€§ | ä¸­ | ä¸­ | ä¿æŒ JWT æ ¼å¼ä¸å˜ï¼Œæ—§ Token ä»å¯ç”¨ |
| åŠ å¯†å¯†é’¥ä¸¢å¤± | ä½ | é«˜ | å¯†é’¥å¯¼å‡ºå·¥å…·ï¼Œç¯å¢ƒå˜é‡å¤‡ä»½ |
| å‰ç«¯é€‚é… | ä¸­ | ä¸­ | API è·¯å¾„ä¿æŒä¸å˜ï¼Œåªé‡æ„å†…éƒ¨å®ç° |

---

## ä¸ƒã€æ€»ç»“

æœ¬é‡æ„æ–¹æ¡ˆçš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

1. **æ¶ˆé™¤æŠ€æœ¯å€ºåŠ¡**ï¼šåˆ é™¤é‡å¤ä»£ç ï¼Œç»Ÿä¸€å®ç°
2. **æå‡å®‰å…¨æ€§**ï¼šåŠ å¯†å­˜å‚¨ï¼Œç§»é™¤æ˜æ–‡å¯†ç 
3. **å¢å¼ºå¯ç»´æŠ¤æ€§**ï¼šåˆ†å±‚æ¶æ„ï¼Œå•ä¸€èŒè´£
4. **ä¿æŒå…¼å®¹æ€§**ï¼šAPI è·¯å¾„ä¸å˜ï¼Œå‰ç«¯æ— æ„ŸçŸ¥

é¢„è®¡æ€»å·¥æ—¶ï¼š**13 å¤©**ï¼ˆå«æµ‹è¯•ï¼‰

é‡æ„åä»£ç é‡é¢„ä¼°ï¼š
- `server.py`: 1600 è¡Œ â†’ 200 è¡Œ (â†“87.5%)
- æ€» API å±‚ä»£ç ï¼šå¢åŠ çº¦ 500 è¡Œï¼ˆService å±‚ï¼‰ï¼Œä½†èŒè´£æ¸…æ™°
- åˆ é™¤é‡å¤ä»£ç çº¦ 300 è¡Œ

---

*æœ¬æ–‡æ¡£ä»…ä¸ºè®¾è®¡æ–¹æ¡ˆï¼Œå®é™…å®æ–½éœ€æ ¹æ®å›¢é˜Ÿæƒ…å†µè°ƒæ•´ã€‚*
