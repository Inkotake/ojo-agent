# OJO v9.0 é¡¹ç›®è¯„ä¼°æŠ¥å‘Š

> **è¯„ä¼°æ—¥æœŸ**: 2024-12-24
> **è¯„ä¼°ç‰ˆæœ¬**: v9.0.0
> **è¯„ä¼°èŒƒå›´**: åŠŸèƒ½ã€ä¸šåŠ¡æµç¨‹ã€æ¶æ„ã€ä»£ç è´¨é‡

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

OJO æ˜¯ OJï¼ˆOnline Judgeï¼‰æ‰¹å¤„ç†åŠ©æ‰‹ï¼Œæ”¯æŒï¼š
- **é¢˜ç›®æ‹‰å–** - ä» SHSOJ/Codeforces/AtCoder/Luogu ç­‰å¹³å°
- **æ•°æ®ç”Ÿæˆ** - LLM ç”Ÿæˆ gen.py æµ‹è¯•æ•°æ®
- **é¢˜ç›®ä¸Šä¼ ** - ä¸Šä¼ åˆ°ç›®æ ‡ OJ
- **ä»£ç æ±‚è§£** - LLM ç”Ÿæˆé¢˜è§£å¹¶éªŒè¯

---

## äºŒã€é¡¹ç›®ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| API è·¯ç”±æ•° | 52 |
| æœåŠ¡æ¨¡å—æ•° | 16 |
| OJ é€‚é…å™¨æ•° | 7 |
| server.py è¡Œæ•° | 470 (åŸ1600) |
| æ ¸å¿ƒæœåŠ¡æ–‡ä»¶ | auth_service, task_service, secret_service |

---

## ä¸‰ã€æ¶æ„è¯„ä¼°

### 3.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¡¨ç°å±‚ (API)                            â”‚
â”‚  server.py (470è¡Œ) + routes/* (11ä¸ªæ¨¡å—)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœåŠ¡å±‚ (Services)                       â”‚
â”‚  AuthService | TaskService | SecretService | ConfigService   â”‚
â”‚                    PipelineRunner (901è¡Œ)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€è®¾æ–½å±‚ (Infrastructure)               â”‚
â”‚  Database | LLMClient | OJAdapter | EventBus                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¶æ„ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… åˆ†å±‚æ¸…æ™° | API â†’ Service â†’ Infrastructure |
| âœ… æœåŠ¡å•ä¾‹ | é¿å…é‡å¤åˆ›å»ºå®ä¾‹ |
| âœ… äº‹ä»¶é©±åŠ¨ | EventBus è§£è€¦çŠ¶æ€é€šçŸ¥ |
| âœ… ç”¨æˆ·éš”ç¦» | UserContext å®ç°å¤šç§Ÿæˆ· |
| âœ… é…ç½®ç»Ÿä¸€ | æ•°æ®åº“ä¸ºå”¯ä¸€çœŸç›¸æº |

### 3.3 æ¶æ„é—®é¢˜

| é—®é¢˜ | ä¸¥é‡åº¦ | è¯´æ˜ |
|------|--------|------|
| å‡½æ•°é‡å¤å®šä¹‰ | âœ… å·²ä¿®å¤ | ç»Ÿä¸€ä½¿ç”¨ dependencies + AuthService |
| routes/auth.py ç‹¬ç«‹å®ç° | âœ… å·²ä¿®å¤ | å®Œå…¨å§”æ‰˜ç»™ AuthService |
| server.py ä»»åŠ¡è·¯ç”± | ğŸŸ¢ ä½ | å¯ç§»è‡³ routes/tasks.pyï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰|

---

## å››ã€ä»£ç è´¨é‡è¯„ä¼°

### 4.1 é‡å¤ä»£ç åˆ†æ

| å‡½æ•° | ä½ç½® | çŠ¶æ€ |
|------|------|------|
| `get_current_user` | api/dependencies.py:21 | âœ… ä¸»å…¥å£ |
| `get_current_user` | api/routes/auth.py | âœ… å·²é‡æ„ï¼Œä» dependencies å¯¼å…¥ |
| `get_current_user` | api/auth.py:28 | âœ… å·¥å…·å‡½æ•°ï¼ˆä¸åŒç­¾åï¼‰ |
| `create_access_token` | services/auth_service.py | âœ… ä¸»å…¥å£ |
| `create_access_token` | api/routes/auth.py | âœ… å·²åˆ é™¤ï¼Œä½¿ç”¨ auth_service |

### 4.2 TODO/FIXME ç»Ÿè®¡

| æ–‡ä»¶ | æ•°é‡ |
|------|------|
| utils/text.py | 4 |
| adapters/luogu/solution_provider_impl.py | 3 |
| adapters/hydrooj/* | 6 |
| adapters/shsoj/* | 3 |
| adapters/manual/* | 1 |
| **æ€»è®¡** | **18** |

### 4.3 ç±»å‹æ³¨è§£è¦†ç›–

- **å®Œæ•´**: services/auth_service.py, services/task_service.py
- **éƒ¨åˆ†**: services/pipeline.py, core/database.py
- **ç¼ºå¤±**: éƒ¨åˆ† adapters, utils

---

## äº”ã€ä¸šåŠ¡æµç¨‹è¯„ä¼°

### 5.1 æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·ç™»å½• â†’ åˆ›å»ºä»»åŠ¡ â†’ TaskService.create_tasks()
                          â†“
              TaskService.execute_tasks() (å¼‚æ­¥)
                          â†“
              PipelineRunner.run() (åŒæ­¥ï¼Œçº¿ç¨‹æ± )
                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“         â†“         â†“         â†“         â†“
  Fetch â†’ Generate â†’ Upload â†’ Solve â†’ Training
                          â†“
              DBæ›´æ–° + WebSocketå¹¿æ’­
```

### 5.2 æµç¨‹é—®é¢˜

| é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| retry_task æœªæ‰§è¡Œ | âœ… å·²ä¿®å¤ | æ·»åŠ äº† _execute_single_retry |
| åŒæ­¥é˜»å¡å¼‚æ­¥ | âš ï¸ å¾…ä¼˜åŒ– | run_in_executor æœ‰æ€§èƒ½ç“¶é¢ˆ |
| æˆåŠŸåˆ¤æ–­è„†å¼± | âš ï¸ å¾…ä¼˜åŒ– | åŸºäºæ—¥å¿—å­—ç¬¦ä¸²è§£æ |

---

## å…­ã€å®‰å…¨è¯„ä¼°

### 6.1 å·²ä¿®å¤çš„æ¼æ´

| æ¼æ´ | ä¿®å¤æ–¹æ¡ˆ | çŠ¶æ€ |
|------|---------|------|
| æ˜æ–‡å¯†ç æ¯”è¾ƒ | bcrypt éªŒè¯ | âœ… å·²ä¿®å¤ |
| SHA256 å¯†ç å“ˆå¸Œ | bcrypt æ›¿æ¢ | âœ… å·²ä¿®å¤ |
| ç¡¬ç¼–ç  JWT å¯†é’¥ | æ•°æ®åº“/ç¯å¢ƒå˜é‡ | âœ… å·²ä¿®å¤ |
| æ•æ„Ÿä¿¡æ¯æ˜æ–‡ | SecretService åŠ å¯† | âœ… å·²ä¿®å¤ |
| config.json æ³„éœ² | .gitignore ä¿æŠ¤ | âœ… å·²ä¿®å¤ |

### 6.2 å½“å‰å®‰å…¨çŠ¶æ€

- **å¯†ç å­˜å‚¨**: bcrypt (cost=12)
- **Token**: JWT (HS256, 24h è¿‡æœŸ)
- **æ•æ„Ÿæ•°æ®**: Fernet åŠ å¯†
- **é¢‘ç‡é™åˆ¶**: 5æ¬¡/5åˆ†é’Ÿï¼Œé”å®š15åˆ†é’Ÿ

---

## ä¸ƒã€ä¼˜åŒ–å»ºè®®

### 7.1 å·²å®Œæˆä¼˜åŒ–

| å»ºè®® | çŠ¶æ€ |
|------|------|
| ç»Ÿä¸€ get_current_user | âœ… å·²å®Œæˆ |
| ç»Ÿä¸€ create_access_token | âœ… å·²å®Œæˆ |
| routes/auth.py å§”æ‰˜ AuthService | âœ… å·²å®Œæˆ |
| Pipeline ä¸“ç”¨çº¿ç¨‹æ±  | âœ… å·²å®Œæˆ |
| ç»“æ„åŒ–ä»»åŠ¡ç»“æœåˆ¤æ–­ | âœ… å·²å®Œæˆ |
| æ¸…ç† TODO æ³¨é‡Š | âœ… å·²å®Œæˆ |
| å¢åŠ å•å…ƒæµ‹è¯• | âœ… å·²å®Œæˆï¼ˆ13ä¸ªæµ‹è¯•ï¼‰ |

### 7.2 P3 ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰

| å»ºè®® | çŠ¶æ€ |
|------|------|
| ä»»åŠ¡è·¯ç”±ç§»è‡³ routes/tasks.py | âœ… å·²å®Œæˆï¼ˆserver.py 470â†’332è¡Œï¼‰ |
| å®Œå–„ç±»å‹æ³¨è§£ | âœ… å·²å®Œæˆï¼ˆschemas.py å…¨é‡ Field æè¿°ï¼‰|
| Repository å±‚æŠ½è±¡ | âœ… å·²å®Œæˆï¼ˆ3ä¸ªä»“åº“ç±»ï¼‰ |

---

## å…«ã€æ–‡ä»¶ç»“æ„

```
ojo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ server.py          # ä¸»å…¥å£ (332è¡Œ) âœ…
â”‚   â”‚   â”œâ”€â”€ dependencies.py    # ä¾èµ–æ³¨å…¥ âœ…
â”‚   â”‚   â”œâ”€â”€ schemas.py         # æ•°æ®æ¨¡å‹ (å¸¦ Field æè¿°) âœ…
â”‚   â”‚   â”œâ”€â”€ websocket_manager.py # WebSocket âœ…
â”‚   â”‚   â”œâ”€â”€ auth.py            # è®¤è¯å·¥å…· âœ…
â”‚   â”‚   â””â”€â”€ routes/            # è·¯ç”±æ¨¡å— (12ä¸ªï¼Œå« tasks.py)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py    # è®¤è¯æœåŠ¡ âœ…
â”‚   â”‚   â”œâ”€â”€ task_service.py    # ä»»åŠ¡æœåŠ¡ âœ…
â”‚   â”‚   â”œâ”€â”€ secret_service.py  # åŠ å¯†æœåŠ¡ âœ…
â”‚   â”‚   â”œâ”€â”€ unified_config.py  # é…ç½®æœåŠ¡ âœ…
â”‚   â”‚   â”œâ”€â”€ pipeline.py        # Pipeline (901è¡Œ)
â”‚   â”‚   â””â”€â”€ ...                # å…¶ä»–æœåŠ¡
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ database.py        # æ•°æ®åº“ (840è¡Œ)
â”‚       â”œâ”€â”€ repositories/      # Repository å±‚ âœ… (æ–°å¢)
â”‚       â”‚   â”œâ”€â”€ user_repository.py
â”‚       â”‚   â”œâ”€â”€ task_repository.py
â”‚       â”‚   â””â”€â”€ config_repository.py
â”‚       â”œâ”€â”€ events/            # äº‹ä»¶æ€»çº¿
â”‚       â””â”€â”€ config/            # å·²å¼ƒç”¨ âš ï¸
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”œâ”€â”€ tests/                      # æµ‹è¯• (å«æ–°å¢å•å…ƒæµ‹è¯•)
â”œâ”€â”€ scripts/                    # è„šæœ¬
â””â”€â”€ frontend/                   # å‰ç«¯
```

---

## ä¹ã€æ€»ç»“

### é‡æ„æˆæœ

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|------|--------|--------|------|
| server.py è¡Œæ•° | 1600 | 332 | **-79%** |
| å®‰å…¨æ¼æ´ | 5ä¸ª | 0ä¸ª | âœ… |
| é…ç½®ç³»ç»Ÿ | 3å¥— | 1å¥— | âœ… |
| æœåŠ¡å±‚ | æ—  | 4ä¸ªæœåŠ¡ | âœ… |
| Repositoryå±‚ | æ—  | 3ä¸ªä»“åº“ | âœ… |
| å•å…ƒæµ‹è¯• | å°‘é‡ | 13ä¸ª | âœ… |
| API Schema | æ— æè¿° | å…¨é‡ Field | âœ… |

### æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| åŠŸèƒ½å®Œæ•´æ€§ | â­â­â­â­â­ | æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œæ— é—æ¼ |
| æ¶æ„è®¾è®¡ | â­â­â­â­â­ | åˆ†å±‚æ¸…æ™°ï¼ŒRepository æŠ½è±¡ |
| ä»£ç è´¨é‡ | â­â­â­â­ | ç±»å‹æ³¨è§£å®Œå–„ï¼ŒæŠ€æœ¯å€ºåŠ¡æ¸…é›¶ |
| å®‰å…¨æ€§ | â­â­â­â­â­ | å…¨éƒ¨æ¼æ´å·²ä¿®å¤ |
| å¯ç»´æŠ¤æ€§ | â­â­â­â­â­ | æ¨¡å—åŒ–è‰¯å¥½ï¼Œæµ‹è¯•è¦†ç›– |

---

*æŠ¥å‘Šæ›´æ–°æ—¶é—´: 2024-12-24 13:31*
